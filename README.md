# gitlab-changes

Generate a **human + AI friendly** report of everything that changed between two GitLab refs (tags / branches / SHAs),
grouped by **Merge Request**, with **full commit messages + diffs**.

Optionally, the workflow can also run **Codex CLI** to turn the generated Markdown report into two Google Sheets-ready CSV files:
- `changelog.csv` — “Changelog” table (Issue + Merge request)
- `tests.csv` — “Tests” matrix (test plan across Android API levels)

---

## What’s in this folder

- `gitlab_changes.py` — interactive exporter script
- `AGENTS.md` — instructions for AI agents (Codex) on how to generate `changelog.csv` + `tests.csv`
- `changes_*.md` — generated reports, e.g. `changes_v1.37_to_release-1.38.md`
- (optional) `changelog.csv`, `tests.csv` — generated by Codex (or your agent) from a `changes_*.md`

---

## Requirements

### 1) Python (required)
- Python 3.9+ recommended

Install Python packages:

```bash
python -m pip install requests rich
```

> `rich` is used for the interactive terminal UI (prompts + progress).

### 2) GitLab Personal Access Token (required)
You need a GitLab token to call the API.

**Create token (GitLab.com or self-managed):**
1. Click your avatar (top-right)
2. **Edit profile**
3. **Personal access tokens**
4. Create a token (name + expiration + scopes)
5. Copy it immediately (shown once)

**Recommended scopes (read-only):**
- `read_api`
- `read_repository`

> Security: never commit tokens. Prefer environment variables.

### 3) Codex CLI (optional, for CSV generation)

If you want the “generate CSV” step:
- Install Node.js 18+ (or 20+) and npm
- Install Codex CLI:

```bash
npm i -g @openai/codex
```

First run (sign-in):
```bash
codex
```

---

## Windows: WSL guidance (recommended for Codex)

Codex CLI supports Windows, but if you run into Node/Codex toolchain issues on native Windows, running inside **WSL** is often smoother.

Install WSL (PowerShell as Admin):

```powershell
wsl --install
```

Open a WSL shell:

```powershell
wsl
```

Then inside WSL, install Node + Codex and run the tool as usual.

---

## How to run the exporter (interactive)

From this folder:

```bash
python gitlab_changes.py
```

The script will ask for:
- GitLab base URL (default: https://gitlab.com)
- Project (path like `group/subgroup/project` or numeric project ID)
- From ref (tag/branch/SHA) — e.g. `v1.37`
- To ref (tag/branch/SHA) — e.g. `release-1.38`
- Output filename (default is generated)
- Whether to use unified diff (`unidiff`)
- Whether to use “straight compare” (from..to) vs merge-base (from...to)
- Token (hidden input), unless `GITLAB_TOKEN` is set

### Token via environment variable (recommended)

PowerShell:
```powershell
$env:GITLAB_TOKEN="glpat-REDACTED"
python .\gitlab_changes.py
```

Bash / WSL:
```bash
export GITLAB_TOKEN="glpat-REDACTED"
python gitlab_changes.py
```

---

## Output format (high level)

The generated Markdown report is organized like:

- Summary (commit count, changed files)
- For each MR:
  - `## Merge request !<iid> <title>`
  - MR metadata + related issues (best effort)
  - `### Commits (detailed)`:
    - Full commit message
    - Per-commit diff
- `## Direct commits (no merge request detected)`:
  - commits in range that GitLab doesn’t associate with an MR

This structure is designed so both humans and AI agents can quickly understand:
- “what changed?”
- “what should be tested?”

---

## Using Codex to generate Google Sheets CSVs

### Option A: Run Codex manually (simplest)
1. Make sure `AGENTS.md` exists in this folder.
2. Generate a report (e.g. `changes_v1.37_to_release-1.38.md`).
3. Run Codex in this folder:

```bash
codex
```

Then ask Codex:
- “Read `changes_v1.37_to_release-1.38.md` and generate `changelog.csv` and `tests.csv` according to `AGENTS.md`.”

Codex will use `AGENTS.md` as project instructions.

### Option B: Run Codex automatically (if your script includes integration)
Some versions of `gitlab_changes.py` include a prompt:
- “After export, run Codex CLI to generate changelog.csv + tests.csv?”

If enabled, the script will run non-interactive `codex exec` and write:
- `changelog.csv`
- `tests.csv`

> If Codex is not found, install it (`npm i -g @openai/codex`) and ensure it’s on PATH.

---

## Troubleshooting

### 401 / 403 errors
- Token is missing, expired, or has insufficient scopes.
- Ensure you have access to the project.

### 404 errors
- Project path is wrong (should be `group/project`, no leading/trailing slashes).
- Refs (tags/branches) may be misspelled.

### “No merge requests detected”
Not all workflows produce commit→MR associations (direct pushes, squash-only strategies, cherry-picks).
Those commits still appear under **Direct commits**.

### Rate limits / slow API
If GitLab rate-limits you, re-run with a small delay in the script prompt (e.g. 0.2–1.0 seconds).

---

## Security notes
- Treat GitLab tokens like passwords.
- Revoke tokens that were accidentally shared.
- The generated `changes_*.md` contains diffs; review before sharing externally.
